---
title: "Testing spsurdev functions"
author: "Román Mínguez (UCLM)"
date: "`r Sys.time()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
        root.dir = "C:/Users/Roman.Minguez/OneDrive/spsurdev")
devtools::load_all(".")
```

Archivo para realizar tests sobre las funciones del paquete `spsur` en la versión en desarrollo disponible en **spsurdev**.

## Modelos uniecuacionales

Comparativa de resultados uniecuacionales con estimaciones de función `lm()` y funciones de estimación espaciales incluidas en `spatialreg`.

```{r, eval = FALSE, echo = FALSE}
### Base de datos Lucas County. Tarda mucho....
data(house, package = "spData")
lw_ho <- spdep::nb2listw(LO_nb, style = "W")
Tformula <- formula(log(price)  ~ TLA + beds)
## Incluimos algunos datos missing...
house[c(1:3,5:7,20:22), c("price")] <- NA
```

```{r}
### Base de datos COL.OLD
data(oldcol, package="spdep")
listw <- spdep::nb2listw(COL.nb, style="W")
ev <- spatialreg::eigenw(listw)
W <- as(listw, "CsparseMatrix")
trMatc <- spatialreg::trW(W, type="mult")
Tformula <- CRIME ~ INC + HOVAL
```


### Modelo uniecuacional no espacial. Comparativa con función `lm()`


```{r}
################## SIM MODEL ############################### 
#### OJO: HAY PEQUEÑAS DIFERENCIAS NUMÉRICAS EN LAS STANDARD DEVIATIONS...   ####
sim_col <- spsurml(formula = Tformula, 
                  data = COL.OLD, type = "sim" )
summary(sim_col)
## Check with lm
lm_col <- lm(formula = Tformula, data = COL.OLD)
summary(lm_col)

```
### Modelos uniecuacionales espaciales. Comparativa con funciones `spatialreg` 
```{r}
################## SLX MODEL ############################### #### OJO: HAY PEQUEÑAS DIFERENCIAS NUMÉRICAS EN LAS STANDARD DEVIATIONS...   ####

system.time( slx_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "slx") )
summary(slx_col)

system.time( lmslx_col <- spatialreg::lmSLX(
                            formula = Tformula, 
                            data = COL.OLD, 
                            listw = listw, 
                            zero.policy = TRUE) )
summary(lmslx_col)
```

```{r}
################## SLM MODEL ############################### ## OJO: COVARIANZAS NUMÉRICAS... EN CUALQUIER CASO TARDA
##      MÁS QUE LA FUNCIÓN spatialreg::lagsarlm() PARA DATOS ##      GRANDES. MIRAR EJEMPLO LUCAS COUNTY. CREO QUE ES
##      POR LA CONSTRUCCIÓN DE LA MATRIZ W A PARTIR DE listw
system.time( slm_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "slm", method = "Matrix",
                        control = list(fdHess = TRUE)) )
summary(slm_col)

system.time( lagsarlm_slm_col <- spatialreg::lagsarlm(
                                  formula = Tformula, 
                                  data = COL.OLD, 
                                  zero.policy = TRUE,         
                                  listw = listw, 
                                  method = "Matrix", 
                                  type = "lag") )
summary(lagsarlm_slm_col)
```

```{r}
################## SDM MODEL ############################### 
system.time( sdm_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "sdm", method = "Matrix",
                        control = list(fdHess = TRUE)) )
summary(sdm_col)
system.time( lagsarlm_sdm_col <- spatialreg::lagsarlm(
                                  formula = Tformula, 
                                  data = COL.OLD, 
                                  zero.policy = TRUE,        
                                  listw = listw, 
                                  method = "Matrix", 
                                  type = "mixed") )
summary(lagsarlm_sdm_col)
```

```{r}
################## SEM MODEL ##############################
system.time( sem_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "sem", method = "Matrix",
                        control = list(fdHess = TRUE)) )
summary(sem_col)
system.time( errorsarlm_sem_col <- 
               spatialreg::errorsarlm(formula = Tformula,
                                data = COL.OLD, 
                                listw = listw, 
                                etype = "error",
                                method = "Matrix") )
summary(errorsarlm_sem_col)
```

```{r}
################## SDEM MODEL ##############################
system.time( sdem_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "sdem", method = "Matrix",
                        control = list(fdHess = TRUE)) )
summary(sdem_col)

system.time( errorsarlm_sdem_col <- spatialreg::errorsarlm(
                                  formula = Tformula, 
                                  data = COL.OLD, 
                                  listw = listw, 
                                  etype = "emixed",
                                  method = "Matrix") )
summary(errorsarlm_sdem_col)
```

```{r}
################## SARAR MODEL ####################### 
system.time( sarar_col <- spsurml(formula = Tformula, 
                        data = COL.OLD, 
                        listw = listw, zero.policy = TRUE,
                        type = "sarar", method = "Matrix",
                        control = list(fdHess = TRUE)) )
summary(sarar_col)
system.time( sacsarlm_sarar_col <-
               spatialreg::sacsarlm(formula = Tformula, 
                                    data = COL.OLD, 
                                    listw = listw, 
                                    method = "Matrix") )
summary(sacsarlm_sarar_col)
```

### Estimación 3sls

Estimación 3sls uniecuacional (modelos slm y sdm):

```{r}
###################### Modelo SLM ####################3
slm_col_3sls <- spsur3sls(formula = Tformula,
                         data = COL.OLD,
                         type = "slm", listw = listw)
summary(slm_col_3sls)

## Comparación con spatialreg::stls()
stsls_slm_col <- spatialreg::stsls(formula = Tformula, 
                                   data = COL.OLD, 
                                   listw = listw)
summary(stsls_slm_col)
```

```{r}
################# Modelo SDM (spatialreg no lo incluye)
sdm_col_3sls <- spsur3sls(formula = Tformula,
                         data = COL.OLD,
                         type = "sdm", listw = listw)
summary(sdm_col_3sls)
```


### Modelos uniecuacionales espaciales. Comparativa de impactos con `spatialreg`. La función `impacts.spsur` devuelve una lista con los impactos en formato `spatialreg` para cada ecuación. Diferencia importante: En `impacts.spsur` no se hace distinción entre tipos de impacto SLX y SLM/SDM como sí se hace en `spatialreg`. 

```{r}
#### IMPACTOS SLM ########
## OJO: LOS IMPACTOS SON MUY SIMILARES PERO DIFIEREN LAS 
## DESVIACIONES TÍPICAS ESTIMADAS. PROBAR CON COVARIANZAS 
## ANALÍTICAS EN LUGAR DE NUMÉRICAS....
system.time( slm_col_imp <- impacts.spsur(slm_col, 
                                    tr = trMatc, R = 1000) )
summary( slm_col_imp[[1]], zstats = TRUE, short = TRUE)

system.time( lagsarlm_slm_col_imp <- spatialreg::impacts( 
                                      lagsarlm_slm_col, 
                                      tr = trMatc, R = 1000) )
summary(lagsarlm_slm_col_imp, zstats = TRUE, short = TRUE)
```

```{r}
#### IMPACTOS SDM ########
## OJO: LOS IMPACTOS SON MUY SIMILARES PERO DIFIEREN LAS 
## DESVIACIONES TÍPICAS ESTIMADAS. PROBAR CON COVARIANZAS 
## ANALÍTICAS EN LUGAR DE NUMÉRICAS....
system.time( sdm_col_imp <- impacts.spsur(sdm_col, 
                                    tr = trMatc, R = 1000) )
summary(sdm_col_imp[[1]], zstats = TRUE, short = TRUE)

system.time( lagsarlm_sdm_col_imp <- spatialreg::impacts( 
                                      lagsarlm_sdm_col, 
                                      tr = trMatc, R = 1000) )
summary(lagsarlm_sdm_col_imp, zstats = TRUE, short = TRUE)
```

```{r}
#### IMPACTOS SARAR ########
system.time( sarar_col_imp <- impacts.spsur(sarar_col, 
                                    tr = trMatc, R = 1000) )
summary(sarar_col_imp[[1]], zstats = TRUE, short = TRUE)

system.time( sacsarlm_sarar_col_imp <- spatialreg::impacts( 
                                      sacsarlm_sarar_col, 
                                      tr = trMatc, R = 1000) )
summary(sacsarlm_sarar_col_imp, zstats = TRUE, short = TRUE)
```

```{r}
#### IMPACTOS SLX ########
## OJO: CAMBIA LA METODOLOGÍA, AQUÍ NO SE OBTIENEN POR SIMULACIÓN. VIP: TAMBIÉN SE OBTIENEN STANDARD DEVIATIONS DE IMPACTOS TOTALES (UTILIZANDO FUNCIÓN gmodels::estimable())
system.time( slx_col_imp <- impacts.spsur(slx_col, 
                                    tr = trMatc, R = 1000) )
summary(slx_col_imp[[1]], zstats = TRUE, short = TRUE)

system.time( lmslx_col_imp <- spatialreg::impacts( 
                                      lmslx_col, 
                                      tr = trMatc, R = 1000) )
summary(lmslx_col_imp, zstats = TRUE, short = TRUE)
```

```{r}
#### IMPACTOS SDEM ########
## OJO: IGUAL METODOLOGÍA QUE CASO SLX
system.time( sdem_col_imp <- impacts.spsur(sdem_col, 
                                    tr = trMatc, R = 1000) )
summary(sdem_col_imp[[1]], zstats = TRUE, short = TRUE)

system.time( errorsarlm_sdem_col_imp <- spatialreg::impacts( 
                                      errorsarlm_sdem_col, 
                                      tr = trMatc, R = 1000) )
summary(errorsarlm_sdem_col_imp, zstats = TRUE, short = TRUE)
```

### Modelos multiecuacionales espaciales. 
Ejemplo con archivo NAT (comparar con PySal)

```{r}
############# EXAMPLE WITH NAT FILE ###############
ncovr <- sf::st_read("C:/Users/Roman.Minguez/OneDrive/spsurdev/notes/ncovr/NAT.shp") 
ncovr_nb <- spdep::poly2nb(ncovr, queen = TRUE)
ncovr_lw <- spdep::nb2listw(ncovr_nb, style = "W", 
                            zero.policy = TRUE)
ncovrW <- as(ncovr_lw, "CsparseMatrix")
tr_ncovrW <- spatialreg::trW(ncovrW, type = "MC")
Tformula <- HR80  | HR90 ~ PS80 + UE80 | PS90 + UE90
```
Estimación de modelos multiecuacionales:
```{r}
NCOVRSUR.sim <- spsurml(formula = Tformula, data = ncovr,
                        listw = ncovr_lw, 
                        method = "Matrix", type = "sim")
summary(NCOVRSUR.sim)
```

```{r}
NCOVRSUR.slx <- spsurml(formula = Tformula, data = ncovr,
                        listw = ncovr_lw, 
                        method = "Matrix", type = "slx")
summary(NCOVRSUR.slx)
```

```{r}
NCOVRSUR.slm <- spsurml(formula = Tformula, data = ncovr,
                        listw = ncovr_lw, 
                        method = "Matrix", type = "slm", 
                        con = list(fdHess = TRUE))
summary(NCOVRSUR.slm)
```

```{r}
NCOVRSUR.sdm <- spsurml(formula = Tformula, data = ncovr,
                        listw = ncovr_lw, 
                        method = "Matrix", type = "sdm", 
                        con = list(fdHess = TRUE))
summary(NCOVRSUR.sdm)
```
Ejemplo impactos con función `impacts.spsur` en modelos SLX y Durbin (el paquete `spatialreg` diferencia entre las funciones de impactos tipo SLX y el resto pero nuestro paquete integra ambas). El output da un objeto tipo `list` con los impactos de cada ecuación en cada elemento de la lista.

```{r}
###########  IMPACTOS SLX  ################
####### OJO: AQUÍ NO UTILIZA SIMULACIÓN Y OBTIENE
####### DESVIACIONES ESTANDARD DE IMPACTOS TOTALES 
NCOVRSUR.slx.impacts <- impacts.spsur(NCOVRSUR.slx, 
                                      tr = tr_ncovrW,
                                      R = 1000)
class(NCOVRSUR.slx.impacts[[1]])
summary(NCOVRSUR.slx.impacts[[1]], zstats = TRUE, 
        short = TRUE)
summary(NCOVRSUR.slx.impacts[[2]], zstats = TRUE, 
        short = TRUE)
```

```{r}
###########  IMPACTOS DURBIN #####################
NCOVRSUR.sdm.impacts <- impacts.spsur(NCOVRSUR.sdm, 
                                      tr = tr_ncovrW,
                                      R = 1000)
class(NCOVRSUR.sdm.impacts[[1]])
summary(NCOVRSUR.sdm.impacts[[1]], zstats = TRUE, 
        short = TRUE)
summary(NCOVRSUR.sdm.impacts[[2]], zstats = TRUE, 
        short = TRUE)
```
Ejemplo funciones `wald_betas` y `wald_deltas` con output tipo objeto `htest`
```{r}
## Testing betas in model NCOVRSUR.slm 
R <- matrix(c(0,1,0,0,-1,0,0,0,1,0,0,-1),
            nrow = 2, byrow = TRUE)
b <- matrix(c(0, 0), ncol = 1)
wbetas_lin <- wald_betas(NCOVRSUR.slm, R = R, b = b)
class(wbetas_lin)
wbetas_lin
```

```{r}
## Testing rhos in model NCOVRSUR.slm 
R <- matrix(c(1, -1), nrow = 1)
b <- matrix(0, ncol = 1)
wdeltas_lin <- wald_deltas(NCOVRSUR.slm, R = R, b = b)
wdeltas_lin
```
Ejemplo función `lr_betas` (OJO: antes se llamaba `lr_betas_spsur`) con output tipo objeto `htest`
```{r}
R <- matrix(c(0,1,0,0,-1,0,0,0,1,0,0,-1),
            nrow = 2, byrow = TRUE)
b <- matrix(c(0, 0), ncol = 1)
lrbetas_lin <- lr_betas(NCOVRSUR.slm, R = R, b = b)
lrbetas_lin
```
Ejemplo función `lrtestspsur` (Test LR de especificación de modelos) con salidas tipo ANOVA. 
```{r}
## Tabla ANOVA de 1 modelo estimado
anova_slm <- lrtestspsur(NCOVRSUR.slm)
class(anova_slm)
anova_slm
```

```{r}
## Comparativa ANOVA de 2 modelos estimados
anova_slm_sdm <- lrtestspsur(objectr = NCOVRSUR.slm,
                                objectu = NCOVRSUR.sdm)
anova_slm_sdm
```

```{r, eval = FALSE, echo = FALSE}
## It is also possible to specify a formula, data and listw  
## vtypes as argument.
### VIP: NO FUNCIONA, PROBLEMAS CON LA FÓRMULA Y NO SÉ
### COMO ARREGLARLO
lr_anova_tests2 <- lrtestspsur(formula = Tformula, 
                               data = ncovr,
                               listw = ncovr_lw,
                               vtypes = c("sim", "slm"))
                                          #,"sem", "sdm"))
```
Ejemplo función `lmtestspsur` (Test LM de especificación de modelos) con salidas tipo `htest`. Devuelve una lista con 5 objetos `htest` (uno para cada contraste)
```{r}
lm_tests <- lmtestspsur(formula = Tformula, data = ncovr,
                  listw = ncovr_lw)
class(lm_tests)
for (i in 1:length(lm_tests)) {
  print(lm_tests[[i]])
}
```

